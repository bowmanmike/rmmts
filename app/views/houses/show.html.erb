<div id="house-header">
  <div class="header-card">
    <h1 id="house-name"><%= @house.name %></h1>
    <div id="house-buttons">
      <% if current_user %>
        <% if current_user.house == @house %>
          <%= form_for current_user do |f| %>
            <%= f.hidden_field :house_id, :value => nil %>
            <%= f.submit "Leave This House" %>
          <% end %>
        <% else %>
          <%= form_for current_user do |f| %>
            <%= f.hidden_field :house_id, :value => @house.id %>
            <%= f.submit "Join This House" %>
          <% end %>
        <% end %>
      <% end %>

      <%= link_to button_tag("Edit or Delete this House"), edit_house_path(@house) %>
    </div>
  </div>



  <div id="roommates" class="header-card">
    <h3>Roommates</h3>
    <ul id="roommates-list">
      <% @house.mates.each do |mate| %>
        <li class="roommate"><%= link_to "#{mate.first_name} #{mate.last_name}", mate_path(mate) %></li>
      <% end %>
    </ul>
  </div>
</div>





<% if current_user && current_user.house == @house %>

  <div id="announcements" class="house-card">

    <h3 class="card-header">House Announcements</h3>
    <div id="announcements-list">
      <% if @announcements.blank? %>
        <p class="no-announcement">No Announcements Yet!</p>
      <% else %>
        <div class="announcement">
          <% @announcements.order(created_at: :desc).each do |announcement| %>
            <h4><%= announcement.title %></h4>
            <p><%= announcement.body %></p>
            <p>Posted by: <%= announcement.mate.first_name %> <%= announcement.mate.last_name %></p>
            <p>Posted at: <%= announcement.created_at.strftime('%A, %d %b %Y %l:%M %p') %></p>
            <%= link_to button_tag("Edit or Delete This Announcement"), edit_house_announcement_path(@house, announcement) %><br>
          <% end %>
        </div>
      <% end %>
    </div>

    <%= link_to button_tag("Add New Announcement"), new_house_announcement_path(@house) %>
  </div>

  <div id="chores" class="house-card">

    <div id="chores-complete" class="chores-card">
      <h3 class="card-header">Completed Chores</h3>
      <% @house.chores.where(complete: true).each do |chore| %>
        <div class="chore">
          <p>
            <strong><%= link_to chore.name, house_chore_path(chore.house, chore) %></strong>
            <% if chore.creator == current_user %>
              <%= link_to "Edit chore", edit_house_chore_path(chore.house, chore) %> |
              <%= link_to "Delete chore", house_chore_path(chore.house, chore), method: :delete, data: { confirm: "Are you sure you want to delete this chore?" } %>
            <% end %>
          </p>
          <p><%= chore.description %></p>
          <p><%= chore.next_due_date.strftime("%a, %e %b %Y") %></p>
          <p>Occurs <%= chore.frequency_alias %></p>
          <%= form_for [@house, chore] do |f| %>
            <%= f.hidden_field :complete, :value => false %>
            <%= f.submit "Mark as Incomplete" %>
          <% end %>
        </div>
      <% end %>
    </div>

    <div id="chores-incomplete" class="chores-card">
      <h3 class="card-header">Incomplete Chores</h3>
      <% @house.chores.where(complete: !true).each do |chore| %>
        <div class="chore">
          <p>
            <strong><%= link_to chore.name, house_chore_path(chore.house, chore) %></strong>
            <% if chore.creator == current_user %>
              <%= link_to "Edit chore", edit_house_chore_path(chore.house, chore) %> |
              <%= link_to "Delete chore", house_chore_path(chore.house, chore), method: :delete, data: { confirm: "Are you sure you want to delete this chore?" } %>
            <% end %>
          </p>
          <p><%= chore.description %></p>
          <p>Due Date: <%= chore.next_due_date.strftime("%a, %e %b %Y") %></p>
          <p>Occurs <%= chore.frequency_alias %></p>
          <%= form_for [@house, chore] do |f| %>
            <%= f.hidden_field :complete, :value => true %>
            <%= f.submit "Mark as Complete" %>
          <% end %>

          <% if chore.mate == nil %>
            <%= form_for [@house, chore] do |f| %>
              <%= f.hidden_field :assign_self, :value => current_user.id %>
              <%= f.submit "Claim this chore" %>
            <% end %>
          <% else %>
            <p>Claimed by <%= chore.mate.username %></p>
          <% end %>

          <% if chore.mate == current_user %>
            <%= form_for [@house, chore] do |f| %>
              <%= f.hidden_field :assign_self, :value => nil %>
              <%= f.submit "Unclaim this chore" %>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>

  </div>

  <% if @house.expenses != nil %>
    <div id="expenses" class="house-card">
      <h3 id="expenses-header" class="card-header">Expenses</h3>

      <div id="expense-list">
        <% @house.expenses.each do |expense| %>
          <div class="expense">
            <p>
              <strong>
                <%= link_to "#{expense.name}: #{number_to_currency(expense.amount)}", house_expense_path(expense.house, expense) %>
              </strong><br>
              Expense due: <%= expense.due_date.strftime("%a, %e %b %Y") %><br>
              Still owed: <%= number_to_currency(expense.amount_owed) %>
            </p>
          </div>
        <% end %>
      </div>

      <div id="expenses-buttons">
        <%= link_to button_tag("Add new chore"), new_house_chore_path(@house) %>
        <%= link_to button_tag("Add new expense"), new_house_expense_path(@house) %>
      </div>
    </div>
  <% end %>

<% end %>
